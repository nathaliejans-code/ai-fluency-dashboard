<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Fluency Dashboard</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #faf8f5;
  --bg-card: #ffffff;
  --bg-elevated: #f5f2ed;
  --bg-inset: #f0ece6;
  --border: #e5dfd6;
  --border-light: #ebe6dd;
  --border-active: #d4cdc2;
  --text-primary: #1c1917;
  --text-secondary: #57534e;
  --text-muted: #a8a29e;
  --text-dim: #d6d3d1;
  --accent: #e85d26;
  --accent-light: rgba(232,93,38,0.08);
  --accent-glow: rgba(232,93,38,0.15);
  --green: #059669;
  --green-bg: rgba(5,150,105,0.07);
  --green-dim: #047857;
  --green-glow: rgba(5,150,105,0.12);
  --yellow: #ca8a04;
  --yellow-bg: rgba(202,138,4,0.07);
  --yellow-dim: #a16207;
  --red: #dc2626;
  --red-bg: rgba(220,38,38,0.06);
  --red-dim: #b91c1c;
  --blue: #2563eb;
  --blue-bg: rgba(37,99,235,0.06);
  --blue-dim: #1d4ed8;
  --radius: 10px;
  --radius-sm: 6px;
  --radius-xs: 4px;
  --font-display: 'DM Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --shadow-glow: 0 0 40px rgba(232,93,38,0.04);
  --shadow-card: 0 1px 3px rgba(28,25,23,0.04), 0 1px 2px rgba(28,25,23,0.03);
  --shadow-lg: 0 20px 60px rgba(28,25,23,0.12), 0 4px 16px rgba(28,25,23,0.06);
}

body {
  font-family: var(--font-display);
  background: var(--bg);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: var(--noise);
  pointer-events: none;
  z-index: 9999;
  opacity: 0.12;
}

/* ========== HEADER ========== */
.header {
  padding: 3rem 2.5rem 2.5rem;
  position: relative;
  overflow: hidden;
  border-bottom: 1px solid var(--border);
}
.header::before {
  content: '';
  position: absolute;
  top: -60%; left: -10%;
  width: 120%;
  height: 200%;
  background: radial-gradient(ellipse at 50% 0%, rgba(255,107,53,0.04) 0%, transparent 60%);
  pointer-events: none;
}
.header-inner {
  max-width: 1280px;
  margin: 0 auto;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 2rem;
  position: relative;
}
.header-left {}
.header h1 {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.03em;
  line-height: 1.2;
}
.header h1 .ai-mark {
  color: var(--accent);
  position: relative;
}
.header h1 .ai-mark::after {
  content: '';
  position: absolute;
  bottom: -2px; left: 0;
  width: 100%; height: 2px;
  background: var(--accent);
  opacity: 0.4;
  border-radius: 1px;
}
.header-sub {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-muted);
  letter-spacing: 0.06em;
  margin-top: 0.4rem;
  text-transform: uppercase;
}
.header-pulse {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--green);
  letter-spacing: 0.04em;
}
.header-pulse .dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 2s ease-in-out infinite;
  box-shadow: 0 0 8px var(--green-glow);
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.8); }
}

/* ========== SUMMARY BAR ========== */
.summary-bar {
  display: flex;
  gap: 1px;
  background: var(--border);
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}
.summary-stat {
  background: var(--bg-card);
  padding: 1rem 1.5rem;
  text-align: center;
  flex: 1;
  min-width: 100px;
  transition: background 0.2s;
}
.summary-stat:hover { background: var(--bg-elevated); }
.summary-stat .label {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  font-weight: 500;
  margin-bottom: 0.15rem;
}
.summary-stat .value {
  font-size: 1.6rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  font-variant-numeric: tabular-nums;
}

/* ========== GRID ========== */
.grid-container {
  padding: 2rem 2.5rem;
  max-width: 1280px;
  margin: 0 auto;
}
.grid-label {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-muted);
  margin-bottom: 1rem;
  padding-left: 0.1rem;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

/* ========== FUNCTION CARDS ========== */
.func-card {
  background: var(--bg-card);
  padding: 1.25rem 1.4rem;
  cursor: pointer;
  transition: all 0.15s ease;
  position: relative;
}
.func-card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 1.4rem; right: 1.4rem;
  height: 1px;
  background: var(--border);
  opacity: 0;
  transition: opacity 0.15s;
}
.func-card:hover {
  background: var(--bg-elevated);
  box-shadow: 0 2px 8px rgba(28,25,23,0.04);
}
.func-card:hover::after { opacity: 1; }
.func-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.6rem;
  gap: 0.5rem;
}
.func-card .card-name {
  font-size: 0.88rem;
  font-weight: 600;
  letter-spacing: -0.01em;
}
.func-card .card-meta {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
.func-card .card-impl-count {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
}
.func-card .card-impl-count::before {
  content: '';
  width: 3px; height: 3px;
  border-radius: 50%;
  background: var(--text-muted);
}

/* Level indicator bar */
.level-indicator {
  height: 2px;
  border-radius: 1px;
  margin-top: 0.8rem;
  opacity: 0.6;
  transition: opacity 0.15s;
}
.func-card:hover .level-indicator { opacity: 1; }
.func-card[data-level="transformative"] .level-indicator { background: var(--green); box-shadow: 0 0 8px rgba(5,150,105,0.15); }
.func-card[data-level="adaptive"] .level-indicator { background: var(--blue); box-shadow: 0 0 8px rgba(37,99,235,0.15); }
.func-card[data-level="capable"] .level-indicator { background: var(--yellow); box-shadow: 0 0 8px rgba(202,138,4,0.15); }
.func-card[data-level="unacceptable"] .level-indicator { background: var(--red); box-shadow: 0 0 8px rgba(220,38,38,0.1); }

/* ========== BADGES ========== */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.15rem 0.55rem;
  border-radius: var(--radius-xs);
  font-family: var(--font-mono);
  font-size: 0.55rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  border: 1px solid;
  white-space: nowrap;
}
.badge-transformative { background: var(--green-bg); color: var(--green-dim); border-color: rgba(5,150,105,0.2); }
.badge-adaptive { background: var(--blue-bg); color: var(--blue-dim); border-color: rgba(37,99,235,0.2); }
.badge-capable { background: var(--yellow-bg); color: var(--yellow-dim); border-color: rgba(202,138,4,0.2); }
.badge-unacceptable { background: var(--red-bg); color: var(--red-dim); border-color: rgba(220,38,38,0.2); }

/* ========== OVERLAY / DETAIL PANEL ========== */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(28,25,23,0.25);
  backdrop-filter: blur(12px);
  z-index: 100;
  justify-content: center;
  align-items: flex-start;
  overflow-y: auto;
  padding: 2rem;
}
.overlay.open { display: flex; }
.detail-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 100%;
  max-width: 980px;
  position: relative;
  margin: 2rem auto;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  overflow: hidden;
}
.detail-panel .close-btn {
  position: absolute;
  top: 1.2rem; right: 1.2rem;
  background: var(--bg-elevated);
  border: 1px solid var(--border-light);
  color: var(--text-muted);
  font-size: 0.85rem;
  cursor: pointer;
  line-height: 1;
  padding: 0.35rem 0.55rem;
  border-radius: var(--radius-xs);
  z-index: 10;
  font-family: var(--font-mono);
  transition: all 0.15s;
}
.detail-panel .close-btn:hover { background: var(--border-light); color: var(--text-primary); border-color: var(--border-active); }

/* Detail header with gradient accent */
.detail-header-wrap {
  padding: 1.8rem 2rem 1.5rem;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.detail-header-wrap::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}
.detail-header-wrap[data-level="transformative"]::before { background: linear-gradient(90deg, var(--green), transparent 80%); }
.detail-header-wrap[data-level="adaptive"]::before { background: linear-gradient(90deg, var(--blue), transparent 80%); }
.detail-header-wrap[data-level="capable"]::before { background: linear-gradient(90deg, var(--yellow), transparent 80%); }
.detail-header-wrap[data-level="unacceptable"]::before { background: linear-gradient(90deg, var(--red), transparent 80%); }
.detail-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}
.detail-header h2 {
  font-size: 1.3rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}
.detail-header .auto-score-note {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  color: var(--text-muted);
  letter-spacing: 0.03em;
}

.detail-body { padding: 1.5rem 2rem 2rem; }

/* ========== METRICS ROW ========== */
.metrics-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 1px;
  background: var(--border);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
  margin-bottom: 1.5rem;
}
.metric-box {
  background: var(--bg-elevated);
  padding: 1rem 1.2rem;
}
.metric-box .m-label {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  font-weight: 500;
  margin-bottom: 0.25rem;
}
.metric-box .m-value {
  font-size: 1.25rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  font-variant-numeric: tabular-nums;
}
.metric-box .m-detail {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-muted);
  margin-top: 0.15rem;
}

/* ========== SECTION BLOCKS ========== */
.section-block {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 1.5rem;
  overflow: hidden;
}
.section-block .section-header {
  background: var(--bg-elevated);
  padding: 0.7rem 1.2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}
.section-block .section-header h3 {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-secondary);
}
.section-block .section-body {
  padding: 1rem 1.2rem;
  background: var(--bg-card);
}

/* ========== MANAGER OVERRIDE ========== */
.override-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}
.override-row select {
  background: var(--bg-inset);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xs);
  padding: 0.45rem 0.65rem;
  color: var(--text-primary);
  font-family: var(--font-display);
  font-size: 0.82rem;
  min-width: 200px;
  transition: border-color 0.15s;
}
.override-row select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }
.override-note {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  color: var(--text-muted);
  letter-spacing: 0.02em;
}

/* ========== RUBRIC ========== */
.rubric-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1px;
  background: var(--border);
  border-radius: var(--radius-xs);
  overflow: hidden;
}
.rubric-item {
  background: var(--bg-card);
  padding: 0.85rem;
  position: relative;
}
.rubric-item.rubric-current {
  background: var(--bg-elevated);
}
.rubric-item.rubric-current::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}
.rubric-item.rubric-current.rubric-transformative::before { background: var(--green); }
.rubric-item.rubric-current.rubric-adaptive::before { background: var(--blue); }
.rubric-item.rubric-current.rubric-capable::before { background: var(--yellow); }
.rubric-item.rubric-current.rubric-unacceptable::before { background: var(--red); }
.rubric-item .rubric-tier {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 0.4rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.rubric-item.rubric-transformative .rubric-tier { color: var(--green); }
.rubric-item.rubric-adaptive .rubric-tier { color: var(--blue); }
.rubric-item.rubric-capable .rubric-tier { color: var(--yellow); }
.rubric-item.rubric-unacceptable .rubric-tier { color: var(--red); }
.rubric-item .rubric-desc { font-size: 0.72rem; color: var(--text-secondary); line-height: 1.55; }
.rubric-item.rubric-current .rubric-desc { color: var(--text-primary); }
.rubric-current-tag {
  font-family: var(--font-mono);
  font-size: 0.5rem;
  background: var(--accent-light);
  color: var(--accent);
  padding: 0.1rem 0.35rem;
  border-radius: 2px;
  letter-spacing: 0.04em;
}

/* ========== FUNCTION METRICS ========== */
.func-metrics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  border-radius: var(--radius-xs);
  overflow: hidden;
}
.func-metric-item {
  background: var(--bg-card);
  padding: 0.85rem;
}
.func-metric-item .fm-label {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  font-weight: 500;
  margin-bottom: 0.2rem;
}
.func-metric-item .fm-value {
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--text-primary);
}

/* ========== TEAM CONFIG ========== */
.team-fields {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 0.8rem;
}
.team-fields label {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  color: var(--text-muted);
  display: block;
  margin-bottom: 0.3rem;
  font-weight: 500;
  letter-spacing: 0.04em;
}
.team-fields input {
  width: 100%;
  background: var(--bg-inset);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xs);
  padding: 0.5rem 0.65rem;
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 0.82rem;
  font-variant-numeric: tabular-nums;
  transition: border-color 0.15s;
}
.team-fields input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }

/* ========== PRIMARY METRIC ========== */
.pm-row { display: flex; gap: 0.6rem; align-items: center; flex-wrap: wrap; }
.pm-row input, .pm-row select {
  background: var(--bg-inset);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xs);
  padding: 0.5rem 0.65rem;
  color: var(--text-primary);
  font-family: var(--font-display);
  font-size: 0.82rem;
  transition: border-color 0.15s;
}
.pm-row input { flex: 1; min-width: 150px; }
.pm-row select { min-width: 130px; }
.pm-row input:focus, .pm-row select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }

/* ========== IMPLEMENTATIONS ========== */
.impl-list { display: flex; flex-direction: column; gap: 1px; background: var(--border); border-radius: var(--radius-xs); overflow: hidden; }
.impl-item {
  background: var(--bg-card);
  padding: 1rem 1.2rem;
  transition: background 0.15s;
}
.impl-item:hover { background: var(--bg-elevated); }
.impl-item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 0.8rem;
  margin-bottom: 0.35rem;
}
.impl-item-name { font-weight: 600; font-size: 0.85rem; letter-spacing: -0.01em; }
.impl-item-controls { display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; }
.impl-item-owner {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--accent);
  margin-bottom: 0.3rem;
  font-weight: 500;
  letter-spacing: 0.02em;
}
.impl-item-desc, .impl-item-impact { font-size: 0.78rem; color: var(--text-secondary); margin-bottom: 0.15rem; line-height: 1.5; }
.impl-item-meta {
  font-family: var(--font-mono);
  font-size: 0.62rem;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
  letter-spacing: 0.02em;
}
.impl-item-time {
  font-family: var(--font-mono);
  font-size: 0.62rem;
  color: var(--text-muted);
  margin-top: 0.3rem;
  letter-spacing: 0.02em;
}

/* ========== EFFICIENCY BREAKDOWN ========== */
.eff-breakdown { margin-top: 0.5rem; }
.eff-breakdown-item {
  display: flex; justify-content: space-between;
  font-family: var(--font-mono);
  font-size: 0.62rem;
  color: var(--text-secondary);
  padding: 0.15rem 0;
}
.eff-breakdown-item .eff-name { flex: 1; }
.eff-breakdown-item .eff-hrs { color: var(--accent); font-weight: 600; min-width: 70px; text-align: right; }

/* ========== BUTTONS ========== */
.btn {
  border: none;
  border-radius: var(--radius-xs);
  padding: 0.5rem 1.1rem;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-display);
  letter-spacing: 0.01em;
}
.btn-primary {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 2px 8px rgba(232,93,38,0.2);
}
.btn-primary:hover { box-shadow: 0 4px 16px rgba(232,93,38,0.3); transform: translateY(-1px); }
.btn-danger {
  background: transparent;
  border: 1px solid var(--border-light);
  color: var(--red);
  padding: 0.2rem 0.55rem;
  font-size: 0.62rem;
  font-family: var(--font-mono);
  letter-spacing: 0.03em;
}
.btn-danger:hover { background: var(--red-bg); border-color: rgba(220,38,38,0.3); }

/* ========== MODAL ========== */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(28,25,23,0.25);
  backdrop-filter: blur(12px);
  z-index: 200;
  justify-content: center; align-items: center;
  padding: 1rem;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  width: 100%; max-width: 540px;
  max-height: 90vh; overflow-y: auto;
  box-shadow: var(--shadow-lg);
}
.modal h3 {
  font-size: 1.05rem;
  margin-bottom: 1.2rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}
.form-group { margin-bottom: 1rem; }
.form-group label {
  display: block;
  font-family: var(--font-mono);
  font-size: 0.62rem;
  color: var(--text-secondary);
  margin-bottom: 0.35rem;
  font-weight: 500;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}
.form-group input, .form-group select, .form-group textarea {
  width: 100%;
  background: var(--bg-inset);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xs);
  padding: 0.55rem 0.7rem;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: var(--font-display);
  transition: border-color 0.15s;
}
.form-group textarea { resize: vertical; min-height: 60px; font-size: 0.82rem; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light);
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; }
.modal-actions { display: flex; gap: 0.6rem; justify-content: flex-end; margin-top: 1.5rem; }
.btn-secondary {
  background: var(--bg-elevated);
  border: 1px solid var(--border-light);
  color: var(--text-secondary);
  padding: 0.5rem 1rem;
  border-radius: var(--radius-xs);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  font-family: var(--font-display);
  transition: all 0.15s;
}
.btn-secondary:hover { background: var(--border-light); color: var(--text-primary); }

/* ========== SCORING INFO ========== */
.scoring-info {
  background: var(--bg-inset);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem 1.2rem;
  margin-top: 1.5rem;
}
.scoring-info h4 {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  font-weight: 600;
  margin-bottom: 0.6rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.scoring-info ul { list-style: none; font-size: 0.68rem; color: var(--text-muted); }
.scoring-info ul li { padding: 0.2rem 0; padding-left: 0.9rem; position: relative; font-family: var(--font-mono); font-size: 0.6rem; letter-spacing: 0.02em; }
.scoring-info ul li::before {
  content: ''; position: absolute; left: 0; top: 50%;
  width: 4px; height: 4px; border-radius: 1px; transform: translateY(-50%);
}
.scoring-info .si-trans li::before { background: var(--green); }
.scoring-info .si-adap li::before { background: var(--blue); }
.scoring-info .si-cap li::before { background: var(--yellow); }
.scoring-info .si-unac li::before { background: var(--red); }
.scoring-info .si-section { margin-bottom: 0.5rem; }
.scoring-info .si-section-title {
  font-family: var(--font-mono);
  font-size: 0.55rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; margin-bottom: 0.15rem;
}
.si-trans .si-section-title { color: var(--green); }
.si-adap .si-section-title { color: var(--blue); }
.si-cap .si-section-title { color: var(--yellow); }
.si-unac .si-section-title { color: var(--red); }
.scoring-formula {
  font-family: var(--font-mono);
  font-size: 0.58rem;
  color: var(--text-muted);
  margin-top: 0.6rem;
  padding-top: 0.6rem;
  border-top: 1px solid var(--border);
  line-height: 1.7;
  letter-spacing: 0.02em;
}

/* ========== ANIMATIONS ========== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.func-card { animation: fadeInUp 0.3s ease backwards; }
.func-card:nth-child(1) { animation-delay: 0.02s; }
.func-card:nth-child(2) { animation-delay: 0.04s; }
.func-card:nth-child(3) { animation-delay: 0.06s; }
.func-card:nth-child(4) { animation-delay: 0.08s; }
.func-card:nth-child(5) { animation-delay: 0.10s; }
.func-card:nth-child(6) { animation-delay: 0.12s; }
.func-card:nth-child(7) { animation-delay: 0.14s; }
.func-card:nth-child(8) { animation-delay: 0.16s; }
.func-card:nth-child(9) { animation-delay: 0.18s; }

.detail-panel {
  animation: panelIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes panelIn {
  from { opacity: 0; transform: translateY(16px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal {
  animation: modalIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(0.96); }
  to { opacity: 1; transform: scale(1); }
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .header { padding: 2rem 1.5rem; }
  .header-inner { flex-direction: column; align-items: flex-start; gap: 0.8rem; }
  .grid-container { padding: 1.5rem; }
  .grid { grid-template-columns: 1fr; }
  .detail-body { padding: 1.2rem; }
  .detail-header-wrap { padding: 1.2rem; }
  .overlay { padding: 0.5rem; }
  .form-row, .form-row-3 { grid-template-columns: 1fr; }
  .rubric-grid { grid-template-columns: 1fr 1fr; }
  .func-metrics-grid { grid-template-columns: 1fr; }
  .metrics-row { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 480px) {
  .rubric-grid { grid-template-columns: 1fr; }
  .metrics-row { grid-template-columns: 1fr; }
}

/* ========== SCROLLBAR ========== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-active); }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="header-left">
      <h1><span class="ai-mark">AI</span> Fluency Dashboard</h1>
      <div class="header-sub">Implementation tracking & maturity scoring</div>
    </div>
    <div class="header-pulse">
      <span class="dot"></span>
      <span>Live</span>
    </div>
  </div>
</div>

<div class="summary-bar" id="summaryBar"></div>

<div class="grid-container">
  <div class="grid-label">Functions</div>
  <div class="grid" id="functionGrid"></div>
</div>

<!-- Detail Panel Overlay -->
<div class="overlay" id="detailOverlay">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<!-- Add Implementation Modal -->
<div class="modal-overlay" id="addImplModal">
  <div class="modal">
    <h3>Add Implementation</h3>
    <form id="implForm">
      <div class="form-group">
        <label>Task / Implementation Name *</label>
        <input type="text" id="implName" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Complexity (1-10) *</label>
          <input type="number" id="implComplexity" min="1" max="10" step="1" required>
        </div>
        <div class="form-group">
          <label>ROI ($ estimated)</label>
          <input type="number" id="implROI" min="0" step="any">
        </div>
      </div>
      <div class="form-group">
        <label>Process Owner *</label>
        <input type="text" id="implOwner" required>
      </div>
      <div class="form-group">
        <label>Description / Process *</label>
        <textarea id="implDesc" required></textarea>
      </div>
      <div class="form-group">
        <label>Impact Description *</label>
        <textarea id="implImpact" required></textarea>
      </div>
      <div class="form-row-3">
        <div class="form-group">
          <label>Time Saved (amount) *</label>
          <input type="number" id="implTimeSaved" min="0" step="any" required>
        </div>
        <div class="form-group">
          <label>Unit *</label>
          <select id="implUnit" required>
            <option value="">Select unit</option>
            <option value="hours/week">hours/week</option>
            <option value="minutes/week">minutes/week</option>
            <option value="minutes/occurrence">minutes/occurrence</option>
            <option value="hours/occurrence">hours/occurrence</option>
          </select>
        </div>
        <div class="form-group" id="freqGroup" style="display:none;">
          <label>Frequency (per week) *</label>
          <input type="number" id="implFrequency" min="0" step="any">
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeAddModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Implementation</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
// ========================
// STATE
// ========================
let functionData = {};
let selectedFunc = null;
let previousLevels = {};

const LEVEL_ORDER = ['unacceptable', 'capable', 'adaptive', 'transformative'];

function cacheLevels() {
  previousLevels = {};
  Object.entries(functionData).forEach(([key, fd]) => {
    const { finalLevel } = getFinalScore(fd);
    previousLevels[key] = finalLevel;
  });
}

function checkForLevelUp() {
  let leveledUp = false;
  let newLevel = '';
  let funcName = '';
  Object.entries(functionData).forEach(([key, fd]) => {
    const { finalLevel } = getFinalScore(fd);
    const prev = previousLevels[key];
    if (prev && LEVEL_ORDER.indexOf(finalLevel) > LEVEL_ORDER.indexOf(prev)) {
      leveledUp = true;
      newLevel = finalLevel;
      funcName = fd.name;
    }
  });
  if (leveledUp) {
    fireConfetti(newLevel, funcName);
  }
}

function fireConfetti(level, funcName) {
  const colors = {
    capable: ['#ffc233', '#ffdb70', '#ffe9a0'],
    adaptive: ['#4c8dff', '#7aabff', '#a8c8ff'],
    transformative: ['#00d68f', '#33e0a8', '#66ebc1']
  };
  const palette = colors[level] || ['#ff6b35', '#ffc233', '#00d68f'];
  confetti({ particleCount: 80, spread: 70, origin: { x: 0.1, y: 0.6 }, colors: palette, angle: 60 });
  confetti({ particleCount: 80, spread: 70, origin: { x: 0.9, y: 0.6 }, colors: palette, angle: 120 });
  setTimeout(() => {
    confetti({ particleCount: 120, spread: 100, origin: { y: 0.7 }, colors: palette, startVelocity: 45 });
  }, 150);
  showLevelUpToast(funcName, level);
}

function showLevelUpToast(funcName, level) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed; top: 2rem; left: 50%; transform: translateX(-50%);
    color: #fff;
    padding: 0.8rem 1.6rem;
    border-radius: 6px; z-index: 9999; font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; font-weight: 700; letter-spacing: -0.01em;
    box-shadow: 0 12px 40px rgba(28,25,23,0.18);
    animation: toastIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex; align-items: center; gap: 0.5rem;
  `;
  const emoji = level === 'transformative' ? 'üöÄ' : level === 'adaptive' ? 'üî•' : '‚≠ê';
  const colorMap = { transformative: '#00d68f', adaptive: '#4c8dff', capable: '#ffc233' };
  toast.style.background = colorMap[level] || '#ff6b35';
  toast.innerHTML = `<span style="font-size:1.2rem">${emoji}</span> ${funcName} ‚Üí ${capitalize(level)}`;
  document.body.appendChild(toast);

  if (!document.getElementById('toast-anim-style')) {
    const style = document.createElement('style');
    style.id = 'toast-anim-style';
    style.textContent = `
      @keyframes toastIn {
        from { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.95); }
        to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
      }
      @keyframes toastOut {
        from { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        to { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.95); }
      }
    `;
    document.head.appendChild(style);
  }

  setTimeout(() => {
    toast.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

// ========================
// API
// ========================
async function api(path, opts = {}) {
  const res = await fetch(path, {
    method: opts.method || 'GET',
    headers: { 'Content-Type': 'application/json' },
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  if (!res.ok) {
    const err = await res.text();
    console.error('API error:', res.status, err);
  }
  return res.json();
}

async function loadAll() {
  functionData = await api('/api/functions');
  renderGrid();
}

// ========================
// SCORING ‚Äî HARDER THRESHOLDS
// ========================
function calcImplLevel(impl) {
  const c = parseFloat(impl.complexity) || 0;
  let complexityScore = 1;
  if (c >= 8) complexityScore = 3;
  else if (c >= 5) complexityScore = 2;

  const roi = parseFloat(impl.roi) || 0;
  let roiScore = 1;
  if (roi > 15000) roiScore = 3;
  else if (roi >= 3000) roiScore = 2;

  let hrsPerWeek = 0;
  const ts = parseFloat(impl.timeSaved) || 0;
  const freq = parseFloat(impl.frequency) || 0;
  if (ts && impl.unit) {
    switch (impl.unit) {
      case 'hours/week': hrsPerWeek = ts; break;
      case 'minutes/week': hrsPerWeek = ts / 60; break;
      case 'minutes/occurrence': hrsPerWeek = (ts * freq) / 60; break;
      case 'hours/occurrence': hrsPerWeek = ts * freq; break;
    }
  }
  let timeScore = 1;
  if (hrsPerWeek > 8) timeScore = 3;
  else if (hrsPerWeek >= 2) timeScore = 2;

  const avg = (complexityScore + roiScore + timeScore) / 3;
  if (avg >= 2.5) return 'transformative';
  if (avg >= 1.8) return 'adaptive';
  return 'capable';
}

function getLevelPoints(level) {
  if (level === 'capable') return 1;
  if (level === 'adaptive') return 3;
  if (level === 'transformative') return 5;
  return 0;
}

function calcImplScore(implementations) {
  let totalPoints = 0;
  const counts = { capable: 0, adaptive: 0, transformative: 0 };
  implementations.forEach(i => {
    const level = calcImplLevel(i);
    totalPoints += getLevelPoints(level);
    counts[level] = (counts[level] || 0) + 1;
  });
  return { totalPoints, counts };
}

function getImplLevel(implementations) {
  const { totalPoints, counts } = calcImplScore(implementations);
  const t = counts.transformative || 0;
  const a = counts.adaptive || 0;
  if (t >= 3) return 'transformative';
  if (t >= 2 && a >= 3 && totalPoints >= 25) return 'transformative';
  if (a >= 6) return 'transformative';
  if (a >= 4) return 'adaptive';
  if (t >= 1 && a >= 2) return 'adaptive';
  if (totalPoints >= 15) return 'adaptive';
  if ((counts.capable || 0) + a + t >= 2 || totalPoints >= 5) return 'capable';
  if ((counts.capable || 0) >= 1 || a >= 1 || t >= 1) return 'capable';
  return 'unacceptable';
}

function calcEfficiency(fd) {
  const tc = fd.teamConfig;
  if (!tc.totalHours || tc.totalHours <= 0) return null;
  let totalHoursWeek = 0;
  const breakdown = [];
  fd.implementations.forEach(impl => {
    if (!impl.timeSaved || !impl.unit) return;
    let hrs = 0;
    const ts = parseFloat(impl.timeSaved) || 0;
    const freq = parseFloat(impl.frequency) || 0;
    switch (impl.unit) {
      case 'hours/week': hrs = ts; break;
      case 'minutes/week': hrs = ts / 60; break;
      case 'minutes/occurrence': hrs = (ts * freq) / 60; break;
      case 'hours/occurrence': hrs = ts * freq; break;
    }
    if (hrs > 0) {
      totalHoursWeek += hrs;
      breakdown.push({ name: impl.name, hours: hrs });
    }
  });
  if (totalHoursWeek === 0) return null;
  const pct = (totalHoursWeek / tc.totalHours) * 100;
  let level = 'capable';
  if (pct >= 30) level = 'transformative';
  else if (pct >= 15) level = 'adaptive';
  return { totalHoursWeek, pct, level, breakdown };
}

const LEVEL_RANK = { unacceptable: 0, capable: 1, adaptive: 2, transformative: 3 };

function getFinalScore(fd) {
  const implLevel = getImplLevel(fd.implementations);
  const eff = calcEfficiency(fd);
  let finalLevel = implLevel;
  let boostNote = '';
  if (eff) {
    if (LEVEL_RANK[eff.level] > LEVEL_RANK[implLevel]) {
      finalLevel = eff.level;
      boostNote = 'Boosted by efficiency';
    } else if (LEVEL_RANK[eff.level] === LEVEL_RANK[implLevel]) {
      boostNote = 'Validated by efficiency';
    }
  }
  return { finalLevel, implLevel, eff, boostNote };
}

function getDisplayLevel(fd) {
  const { finalLevel } = getFinalScore(fd);
  if (fd.managerOverride && fd.managerOverride !== '') return fd.managerOverride;
  return finalLevel;
}

// ========================
// RENDER
// ========================
function renderGrid() {
  const grid = document.getElementById('functionGrid');
  grid.innerHTML = '';
  let totalImpl = 0;
  const levelCounts = { transformative: 0, adaptive: 0, capable: 0, unacceptable: 0 };

  Object.entries(functionData).forEach(([key, fd]) => {
    const displayLevel = getDisplayLevel(fd);
    const implCount = fd.implementations.length;
    totalImpl += implCount;
    levelCounts[displayLevel]++;

    const hasOverride = fd.managerOverride && fd.managerOverride !== '';

    const card = document.createElement('div');
    card.className = 'func-card';
    card.dataset.level = displayLevel;
    card.onclick = () => openDetail(key);
    card.innerHTML = `
      <div class="card-header">
        <span class="card-name">${fd.name}</span>
        <span class="badge badge-${displayLevel}">${displayLevel}</span>
      </div>
      <div class="card-meta">
        <span class="card-impl-count">${implCount} impl${implCount !== 1 ? 's' : ''}</span>
        ${hasOverride ? '<span style="color:var(--accent);font-style:italic">override</span>' : ''}
      </div>
      <div class="level-indicator"></div>
    `;
    grid.appendChild(card);
  });

  document.getElementById('summaryBar').innerHTML = `
    <div class="summary-stat"><div class="label">Functions</div><div class="value">${Object.keys(functionData).length}</div></div>
    <div class="summary-stat"><div class="label">Implementations</div><div class="value">${totalImpl}</div></div>
    <div class="summary-stat"><div class="label">Transformative</div><div class="value" style="color:var(--green)">${levelCounts.transformative}</div></div>
    <div class="summary-stat"><div class="label">Adaptive</div><div class="value" style="color:var(--blue)">${levelCounts.adaptive}</div></div>
    <div class="summary-stat"><div class="label">Capable</div><div class="value" style="color:var(--yellow)">${levelCounts.capable}</div></div>
    <div class="summary-stat"><div class="label">Unacceptable</div><div class="value" style="color:var(--red)">${levelCounts.unacceptable}</div></div>
  `;
}

function openDetail(key) {
  selectedFunc = key;
  const fd = functionData[key];
  const { finalLevel, implLevel, eff, boostNote } = getFinalScore(fd);
  const displayLevel = getDisplayLevel(fd);
  const { totalPoints, counts } = calcImplScore(fd.implementations);

  const hasOverride = fd.managerOverride && fd.managerOverride !== '';

  let efficiencyHTML = '';
  if (eff) {
    const breakdownHTML = eff.breakdown.map(b =>
      `<div class="eff-breakdown-item"><span class="eff-name">${esc(b.name)}</span><span class="eff-hrs">${b.hours.toFixed(1)} hrs/wk</span></div>`
    ).join('');
    efficiencyHTML = `
      <div class="metric-box">
        <div class="m-label">Efficiency</div>
        <div class="m-value" style="color:${levelColor(eff.level)}">${eff.pct.toFixed(1)}%</div>
        <div class="m-detail">${eff.totalHoursWeek.toFixed(1)}h saved / ${fd.teamConfig.totalHours}h total</div>
        <div class="eff-breakdown">${breakdownHTML}</div>
      </div>
    `;
  }

  const boostHTML = boostNote ? `<div class="m-detail" style="color:var(--accent);margin-top:0.15rem">${boostNote}</div>` : '';

  // Rubric
  const rubrics = fd.rubrics || {};
  const tiers = ['unacceptable', 'capable', 'adaptive', 'transformative'];
  const rubricHTML = tiers.map(tier => {
    const isCurrent = displayLevel === tier;
    return `
      <div class="rubric-item rubric-${tier}${isCurrent ? ' rubric-current' : ''}">
        <div class="rubric-tier">${capitalize(tier)}${isCurrent ? ' <span class="rubric-current-tag">current</span>' : ''}</div>
        <div class="rubric-desc">${esc(rubrics[tier] || 'No description available')}</div>
      </div>
    `;
  }).join('');

  // Function metrics
  const funcMetricsHTML = (fd.defaultPrimaryMetric || fd.defaultEfficiencyMetric) ? `
    <div class="section-block">
      <div class="section-header"><h3>Function Metrics</h3></div>
      <div class="section-body" style="padding:0;">
        <div class="func-metrics-grid">
          ${fd.defaultPrimaryMetric ? `<div class="func-metric-item"><div class="fm-label">Primary Metric (RPE)</div><div class="fm-value">${esc(fd.defaultPrimaryMetric)}</div></div>` : ''}
          ${fd.defaultEfficiencyMetric ? `<div class="func-metric-item"><div class="fm-label">Efficiency Metric</div><div class="fm-value">${esc(fd.defaultEfficiencyMetric)}</div></div>` : ''}
        </div>
      </div>
    </div>
  ` : '';

  const implListHTML = fd.implementations.map(impl => {
    const implLvl = calcImplLevel(impl);
    return `
    <div class="impl-item">
      <div class="impl-item-header">
        <div>
          <div class="impl-item-name">${esc(impl.name)} <span class="badge badge-${implLvl}" style="margin-left:0.3rem">${implLvl}</span></div>
          ${impl.owner ? `<div class="impl-item-owner">${esc(impl.owner)}</div>` : ''}
        </div>
        <div class="impl-item-controls">
          <button class="btn btn-danger" onclick="deleteImpl('${key}','${impl.id}')">DEL</button>
        </div>
      </div>
      <div class="impl-item-meta">C:${impl.complexity || '?'}/10 &middot; ROI:$${(impl.roi || 0).toLocaleString()}</div>
      ${impl.description ? `<div class="impl-item-desc">${esc(impl.description)}</div>` : ''}
      ${impl.impact ? `<div class="impl-item-impact" style="color:var(--accent)"><strong>Impact:</strong> ${esc(impl.impact)}</div>` : ''}
      ${impl.timeSaved ? `<div class="impl-item-time">‚è± ${impl.timeSaved} ${impl.unit || ''}${impl.unit && impl.unit.includes('occurrence') ? ' (√ó' + (impl.frequency||0) + '/wk)' : ''}</div>` : ''}
    </div>
  `;}).join('');

  const panel = document.getElementById('detailPanel');
  panel.innerHTML = `
    <button class="close-btn" onclick="closeDetail()">‚úï</button>
    <div class="detail-header-wrap" data-level="${displayLevel}">
      <div class="detail-header">
        <h2>${fd.name}</h2>
        <span class="badge badge-${displayLevel}">${displayLevel}</span>
        ${hasOverride ? `<span class="auto-score-note">auto-score: ${finalLevel}</span>` : ''}
      </div>
    </div>
    <div class="detail-body">
      <div class="metrics-row">
        <div class="metric-box">
          <div class="m-label">Official Level</div>
          <div class="m-value" style="color:${levelColor(displayLevel)}">${capitalize(displayLevel)}</div>
          ${boostHTML}
        </div>
        <div class="metric-box">
          <div class="m-label">Auto-Score</div>
          <div class="m-value" style="color:${levelColor(finalLevel)}">${capitalize(finalLevel)}</div>
          <div class="m-detail">${totalPoints}pts ¬∑ ${counts.transformative||0}T/${counts.adaptive||0}A/${counts.capable||0}C</div>
        </div>
        ${efficiencyHTML}
        <div class="metric-box">
          <div class="m-label">Implementations</div>
          <div class="m-value">${fd.implementations.length}</div>
        </div>
      </div>

      <div class="section-block">
        <div class="section-header">
          <h3>Manager Override</h3>
        </div>
        <div class="section-body">
          <div class="override-row">
            <select onchange="updateOverride('${key}', this.value)">
              <option value="" ${!hasOverride ? 'selected' : ''}>Use auto-score (${capitalize(finalLevel)})</option>
              <option value="unacceptable" ${fd.managerOverride==='unacceptable'?'selected':''}>Unacceptable</option>
              <option value="capable" ${fd.managerOverride==='capable'?'selected':''}>Capable</option>
              <option value="adaptive" ${fd.managerOverride==='adaptive'?'selected':''}>Adaptive</option>
              <option value="transformative" ${fd.managerOverride==='transformative'?'selected':''}>Transformative</option>
            </select>
            <span class="override-note">Sets official quarterly level. Overrides auto-scoring for reporting.</span>
          </div>
        </div>
      </div>

      <div class="section-block">
        <div class="section-header"><h3>Maturity Rubric</h3></div>
        <div class="section-body" style="padding:0;">
          <div class="rubric-grid">${rubricHTML}</div>
        </div>
      </div>

      ${funcMetricsHTML}

      <div class="section-block">
        <div class="section-header"><h3>Team Configuration</h3></div>
        <div class="section-body">
          <div class="team-fields">
            <div><label>Full-time</label><input type="number" min="0" value="${fd.teamConfig.fullTime}" onchange="updateTeam('${key}','fullTime',this.value)"></div>
            <div><label>Part-time</label><input type="number" min="0" value="${fd.teamConfig.partTime}" onchange="updateTeam('${key}','partTime',this.value)"></div>
            <div><label>PT Hrs/Wk</label><input type="number" min="0" value="${fd.teamConfig.partTimeHours}" onchange="updateTeam('${key}','partTimeHours',this.value)"></div>
            <div><label>Total Hrs/Wk</label><input type="number" min="0" value="${fd.teamConfig.totalHours}" onchange="updateTeam('${key}','totalHours',this.value)"></div>
          </div>
        </div>
      </div>

      <div class="section-block">
        <div class="section-header"><h3>Primary Metric (Custom)</h3></div>
        <div class="section-body">
          <div class="pm-row">
            <input type="text" placeholder="e.g. Revenue per rep" value="${esc(fd.metrics.primary||'')}" onchange="updatePrimaryMetric('${key}','primary',this.value)">
            <select onchange="updatePrimaryMetric('${key}','primaryLevel',this.value)">
              <option value="">No level</option>
              <option value="capable" ${fd.metrics.primaryLevel==='capable'?'selected':''}>Capable</option>
              <option value="adaptive" ${fd.metrics.primaryLevel==='adaptive'?'selected':''}>Adaptive</option>
              <option value="transformative" ${fd.metrics.primaryLevel==='transformative'?'selected':''}>Transformative</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section-block">
        <div class="section-header">
          <h3>Implementations</h3>
          <button class="btn btn-primary" onclick="openAddModal('${key}')" style="padding:0.35rem 0.8rem;font-size:0.7rem;">+ Add</button>
        </div>
        <div class="section-body" style="padding:0;">
          ${implListHTML ? `<div class="impl-list">${implListHTML}</div>` : '<div style="padding:1.2rem;color:var(--text-muted);font-size:0.82rem;">No implementations yet.</div>'}
        </div>
      </div>

      <div class="scoring-info">
        <h4>Scoring Logic</h4>
        <div class="si-section si-trans">
          <div class="si-section-title">Transformative</div>
          <ul>
            <li>3+ Transformative implementations</li>
            <li>2T + 3A + 25+ points</li>
            <li>6+ Adaptive implementations</li>
            <li>OR efficiency >= 30%</li>
          </ul>
        </div>
        <div class="si-section si-adap">
          <div class="si-section-title">Adaptive</div>
          <ul>
            <li>4+ Adaptive implementations</li>
            <li>1T + 2+ Adaptive</li>
            <li>15+ total points</li>
            <li>OR efficiency 15-30%</li>
          </ul>
        </div>
        <div class="si-section si-cap">
          <div class="si-section-title">Capable</div>
          <ul>
            <li>2+ implementations</li>
            <li>5+ total points</li>
            <li>OR efficiency &lt; 15%</li>
          </ul>
        </div>
        <div class="si-section si-unac">
          <div class="si-section-title">Unacceptable</div>
          <ul><li>No qualifying implementations</li></ul>
        </div>
        <div class="scoring-formula">
          C:1pt A:3pts T:5pts<br>
          Impl: C(1-4) A(5-7) T(8-10) ¬∑ ROI: C(&lt;3K) A(3-15K) T(&gt;15K) ¬∑ Time: C(&lt;2h) A(2-8h) T(&gt;8h/wk)<br>
          avg‚â•2.5‚ÜíT, ‚â•1.8‚ÜíA, else‚ÜíC<br>
          Official = override || max(impl_score, efficiency)
        </div>
      </div>
    </div>
  `;
  document.getElementById('detailOverlay').classList.add('open');

  if (displayLevel === 'transformative') {
    setTimeout(() => fireConfetti('transformative', fd.name), 300);
  }
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('open');
  selectedFunc = null;
}

function levelColor(level) {
  switch(level) {
    case 'transformative': return 'var(--green)';
    case 'adaptive': return 'var(--blue)';
    case 'capable': return 'var(--yellow)';
    default: return 'var(--red)';
  }
}
function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

// ========================
// ACTIONS
// ========================
async function deleteImpl(funcKey, implId) {
  if (!confirm('Delete this implementation?')) return;
  await api(`/api/functions/${funcKey}/implementations/${implId}`, { method: 'DELETE' });
  await loadAll();
  openDetail(funcKey);
}

async function updateTeam(funcKey, field, val) {
  const body = {};
  body[field] = parseFloat(val) || 0;
  cacheLevels();
  await api(`/api/functions/${funcKey}/team`, { method: 'PUT', body });
  await loadAll();
  checkForLevelUp();
  openDetail(funcKey);
}

async function updatePrimaryMetric(funcKey, field, val) {
  const body = {};
  body[field] = val;
  await api(`/api/functions/${funcKey}/metrics`, { method: 'PUT', body });
}

async function updateOverride(funcKey, val) {
  cacheLevels();
  await api(`/api/functions/${funcKey}/override`, { method: 'PUT', body: { managerOverride: val } });
  await loadAll();
  checkForLevelUp();
  openDetail(funcKey);
}

let addModalFunc = null;
function openAddModal(funcKey) {
  addModalFunc = funcKey;
  document.getElementById('implForm').reset();
  document.getElementById('freqGroup').style.display = 'none';
  document.getElementById('addImplModal').classList.add('open');
}
function closeAddModal() {
  document.getElementById('addImplModal').classList.remove('open');
  addModalFunc = null;
}

document.getElementById('implUnit').addEventListener('change', function() {
  const isOccurrence = this.value.includes('occurrence');
  document.getElementById('freqGroup').style.display = isOccurrence ? '' : 'none';
  document.getElementById('implFrequency').required = isOccurrence;
});

document.getElementById('implForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (!addModalFunc) return;
  const impl = {
    name: document.getElementById('implName').value.trim(),
    complexity: parseFloat(document.getElementById('implComplexity').value) || 0,
    roi: parseFloat(document.getElementById('implROI').value) || 0,
    owner: document.getElementById('implOwner').value.trim(),
    description: document.getElementById('implDesc').value.trim(),
    impact: document.getElementById('implImpact').value.trim(),
    timeSaved: parseFloat(document.getElementById('implTimeSaved').value) || 0,
    unit: document.getElementById('implUnit').value,
    frequency: parseFloat(document.getElementById('implFrequency').value) || 0
  };
  if (!impl.name) return;
  const funcKey = addModalFunc;
  cacheLevels();
  await api(`/api/functions/${funcKey}/implementations`, { method: 'POST', body: impl });
  closeAddModal();
  await loadAll();
  checkForLevelUp();
  openDetail(funcKey);
});

document.getElementById('detailOverlay').addEventListener('click', function(e) { if (e.target === this) closeDetail(); });
document.getElementById('addImplModal').addEventListener('click', function(e) { if (e.target === this) closeAddModal(); });

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('addImplModal').classList.contains('open')) closeAddModal();
    else if (document.getElementById('detailOverlay').classList.contains('open')) closeDetail();
  }
});

loadAll();
</script>
</body>
</html>
